<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cliente JWT – Spring Boot</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      background: #f9fafb;
      color: #333;
    }
    h1 { text-align: center; color: #1e40af; }
    fieldset { 
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background: white;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    input, button, textarea {
      font-size: 1rem;
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
    }
    input[type="text"], input[type="password"] {
      width: 98%;
    }
    button {
      cursor: pointer;
      background: #2563eb;
      color: white;
      border: none;
      margin-right: 0.5rem;
    }
    button:hover { background: #1e3a8a; }
    textarea { width: 100%; height: 150px; }
    .token-box {
      word-break: break-all;
      padding: .5rem;
      border: 1px solid #ccc;
      background: #f7f7f7;
      border-radius: 6px;
      margin-top: 0.5rem;
    }
    .ok { color: green; }
    .error { color: red; }
    .payload {
      background: #eef2ff;
      padding: .5rem;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>Cliente JWT – Spring Boot</h1>

  <fieldset>
    <legend>Configuración del servidor</legend>
    <label>
      URL base del backend:
      <input id="baseUrl" type="text" value="http://localhost:8081/auth">
    </label>
  </fieldset>

  <fieldset>
    <legend>Login</legend>
    <label>Correo Electrónico:</label>
    <input id="email" type="text" value="usuario@dominio.com"><br><br>
    <label>Contraseña:</label>
    <input id="password" type="password" value="12345678"><br><br>
    <button id="btnLogin">Login y obtener JWT</button>
    <button id="btnLogout" style="background:#ef4444;">Cerrar sesión</button>
    <p id="loginStatus"></p>

    <div>
      <strong>JWT actual:</strong>
      <strong>Authorization en Value!</strong>
      <div id="tokenBox" class="token-box">(sin token)</div>
    </div>
    <div id="payloadDecoded" class="payload"></div>
  </fieldset>

  <fieldset>
    <legend>Rutas protegidas</legend>
    <button id="btnPerfil">GET /perfil</button>
    <button id="btnAdmin">GET /admin</button>
    <p>Respuesta del servidor:</p>
    <textarea id="respuesta" readonly></textarea>
  </fieldset>

  <script>
    const baseUrlInput = document.getElementById("baseUrl");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnPerfil = document.getElementById("btnPerfil");
    const btnAdmin = document.getElementById("btnAdmin");
    const loginStatus = document.getElementById("loginStatus");
    const tokenBox = document.getElementById("tokenBox");
    const respuestaArea = document.getElementById("respuesta");
    const payloadDecoded = document.getElementById("payloadDecoded");

    // Cargar token guardado al iniciar
    let currentToken = localStorage.getItem("jwtToken") || null;
    if (currentToken) {
      tokenBox.textContent = currentToken;
      decodeAndShowPayload(currentToken);
    }

    // Función para login
    async function login() {
      const baseUrl = baseUrlInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      loginStatus.textContent = "Enviando login...";
      loginStatus.className = "";

      try {
        const res = await fetch(baseUrl + "/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          const text = await res.text();
          loginStatus.textContent = "Error en login: " + res.status + " - " + text;
          loginStatus.className = "error";
          currentToken = null;
          tokenBox.textContent = "(sin token)";
          localStorage.removeItem("jwtToken");
          payloadDecoded.textContent = "";
          return;
        }

        const data = await res.json();
        currentToken = data.token; // <-- cambia esto si tu backend usa otro campo
        localStorage.setItem("jwtToken", currentToken);

        tokenBox.textContent = "Bearer "+currentToken;
        decodeAndShowPayload(currentToken);

        loginStatus.textContent = "Login correcto. Token guardado.";
        loginStatus.className = "ok";
      } catch (err) {
        loginStatus.textContent = "Error de red: " + err;
        loginStatus.className = "error";
      }
    }

    // Función para logout
    function logout() {
      localStorage.removeItem("jwtToken");
      currentToken = null;
      tokenBox.textContent = "(sin token)";
      payloadDecoded.textContent = "";
      respuestaArea.value = "";
      loginStatus.textContent = "Sesión cerrada.";
      loginStatus.className = "";
    }

    // Llamada a ruta protegida
    async function callProtected(path) {
      const baseUrl = baseUrlInput.value.trim();
      respuestaArea.value = "";

      if (!currentToken) {
        respuestaArea.value = "No hay token. Haz login primero.";
        return;
      }

      try {
        const res = await fetch(baseUrl + path, {
          method: "GET",
          headers: {
            "Authorization": "Bearer " + currentToken
          }
        });

        const text = await res.text();
        respuestaArea.value = "Status: " + res.status + "\n\n" + text;
      } catch (err) {
        respuestaArea.value = "Error de red: " + err;
      }
    }

    // Decodificar el payload del JWT para mostrar usuario y rol
    function decodeAndShowPayload(token) {
      try {
        const parts = token.split('.');
        if (parts.length !== 3) return;
        const payload = JSON.parse(atob(parts[1]));
        payloadDecoded.textContent = JSON.stringify(payload, null, 2);
      } catch (e) {
        payloadDecoded.textContent = "(Error al decodificar payload)";
      }
    }

    btnLogin.addEventListener("click", login);
    btnLogout.addEventListener("click", logout);
    btnPerfil.addEventListener("click", () => callProtected("/privado"));
    btnAdmin.addEventListener("click", () => callProtected("/admin"));
  </script>
</body>
</html>
